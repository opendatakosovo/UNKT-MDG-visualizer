<!DOCTYPE html>
<html>
<head>
    <!-- Albanian Version -->
    <title>Kosovo Mosaic</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css" integrity="sha384-aUGj/X2zp5rLCbBxumKTCw2Z50WgIr1vs/PFN4praOTvYXWlVyh2UtNUU0KAUhAX" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" integrity="sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ==" crossorigin="anonymous"></script>

    <!-- D3 charts -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <link rel="stylesheet" type="text/css" href="static/css/style.css">
    <link rel="stylesheet" type="text/css" href="static/css/radio-button.css">

    <!-- jquery plugin -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="data/output_data.js"></script>

    <!-- Bootstrap popup modal plugins -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>


    <!-- Highcharts map JavaScript -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/maps/modules/map.js"></script>
    <script src="https://code.highcharts.com/maps/modules/data.js"></script>
    <script src="static/highcharts/kv-all.js"></script>

    <style type="text/css">
        #container {
            height: 500px; 
            min-width: 310px; 
            max-width: 800px; 
            margin: 0 auto; 
        }
        .loading {
            margin-top: 10em;
            text-align: center;
            color: gray;
        }

        @media only screen 
        and (min-device-width : 320px) 
        and (max-device-width : 480px) {
            /* Styles */

            #aster-chart {
                width :200px; 
                background-color:#666666 !important;
            }
            #aster-chart-popup {
                width :100px !important;
            }

        }
        .tooltip {
          z-index: 1151 !important;
        }
        .style-eight { padding: 0; border: none; border-top: medium double #333; color: #333; text-align: center; } 
        .style-eight:after { content: "ยง"; display: inline-block; position: relative; top: -0.7em; font-size: 1.5em; padding: 0 0.25em; background: white; }
    </style>

    <script type="text/javascript">
        var all_data = getAllData();
        municipality_names_to_fix = {
            "Gliogovc": "Drenas"
        }
        width = window.screen.availWidth
        console.log(width)
        function drawMap(indicator, s_or_d, data){
            var municipalities_data = [];
            for (key in data){
                var name = key
                if (key == "Gllogoc"){
                    name = "Drenas";
                } else if (key == "Mitrovica South") {
                    name = "Mitrovice"
                } else if (key == "Mitrovica North") {
                    name = "Mitrovice Veriore"
                } else if (key == "Novoberda") {
                    name = "Novoberde"
                } else if (key == "Mitrovica") {
                    name = "Mitrovice"
                }
                var value = data[key][indicator]
                if (!(isNaN(value))){
                    if (value.toString().length > 4){
                        value = value.toFixed(1);
                    }
                    var json_key = {
                        "hc-key": "kv-" + slugify(name),
                        "value": value
                    }
                    municipalities_data.push(json_key);
                }
            }
            // Initiate the chart
            $('#container').highcharts('Map', {
                title : {
                    text : ''
                },

                mapNavigation: {
                    enabled: true,
                    buttonOptions: {
                        verticalAlign: 'bottom'
                    }
                },

                colorAxis: {
                    min: 0,
                    maxColor: '#73AD21'
                },
                plotOptions: {
                    enabled: true,
                    series: {
                        point: {
                            events: {
                                select: function () {
                                    $('#popup-button').click();
                                    var text = 'Selected ' + this.name + ' (' + this.value + '%)';
                                    var muni = this.name;
                                    if (muni == "Prishtine"){
                                        muni = "Pristina"
                                    } else if (muni == "Novoberde") {
                                        muni = "Novoberda"
                                    } else if (muni == "Mitrovice") {
                                        muni = "Mitrovica"
                                    } else if (muni == "Mitrovice Veriore") {
                                        muni = "Mitrovica North"
                                    } else if (muni == "Drenas") {
                                        muni = "Gllogoc"
                                    }
                                    $('.modal-title').empty();
                                    $('.modal-title').append("Municipality Profile: <b>" + this.name + "</b>");
                                    $("#municipality-popup").empty();
                                    var viti = $('input[name=radio]:checked', '#my-form').val()
                                    var aster_div = "aster-chart-popup";
                                    var aster_text_div = "aster-text-popup";
                                    var indicator = $("#indicator-select").val();
                                    start(muni, "S", aster_div, data[muni], "label");
                                    indicator_id = indicator.replace("Satisfaction with ", "");
                                    $("#municipality-popup").append(text);
                                    $("#aster-chart-popup").find('.solidArc').click(function(){
                                        selected_indicator = $(this).attr("value");
                                        drawLineChart(selected_indicator, muni);
                                    })
                                    $("#aster-chart-popup").find("#" + slugify(indicator)).d3Click();
                                }
                            }
                        }
                    }
                },
                tooltip: {
                    backgroundColor: '#FCFFC5',
                    fontSize: "15px",
                    valueSuffix: "%"
                },

                series : [{
                    data : municipalities_data,
                    mapData: Highcharts.maps['countries/kv/kv-all'],
                    joinBy: 'hc-key',
                    allowPointSelect: true,
                    name: capitalizeFirstLetter(indicator),
                    states: {
                        hover: {
                            color: 'grey'
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        format: '{point.name}'
                    }
                }]
            });
        }

        function drawLineChart(indicator, municipality){
            var categories = []
            var json_data = {}
            var data = []
            for (key in all_data){
                categories.push(key);
                value = all_data[key][municipality][indicator]
                if (value != undefined && !(isNaN(value))){
                    if (value.toString().length > 4){
                        value = value.toFixed(1);
                    }
                    data.push(Number(value));
                } else {
                    data.push(null)
                }
            }
            $('#line-chart').highcharts({
                title: {
                    text: capitalizeFirstLetter(indicator),
                    x: -20 //center
                },
                xAxis: {
                    categories: categories
                },
                yAxis: {
                    min: 0,
                    max: 100,
                    title: {
                        text: 'Satisfaction percentage'
                    },
                    plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }]
                },
                tooltip: {
                    valueSuffix: '%'
                },
                legend: {
                    layout: 'horizontal',
                    verticalAlign: 'bottom'
                },
                series: [{
                    name: municipality,
                    data: data
                }]
            });
        }

        function bindIndicatorSelectBox(year, s_or_d){
            $("#indicator-select").empty();
            for (key in all_data[year]["Pristina"]){
                $("#indicator-select").append("<option value='"+key+"'>"+capitalizeFirstLetter(key)+"</option>");
            }
        }

        jQuery.fn.d3Click = function () {
            this.each(function (i, e) {
                var evt = document.createEvent("MouseEvents");
                evt.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
                e.dispatchEvent(evt);
            });
        };

        function bindSelectBoxOnLabelClick(s_or_d){
            $("#aster-chart").find('.solidArc').click(function(){
                selected_indicator = $(this).attr("value");
                $("#indicator-select").val(selected_indicator);
                var viti = $('input[name=radio]:checked', '#my-form').val()
                drawMap(selected_indicator, "S", all_data[viti]);
            })
        }

        function rankingByMunicipality(year, indicator, muni, aster_div, s_or_d) {
            var data = {}
            for (var key in all_data[year]){
                data[key] = all_data[year][key][indicator]
            }
            var municipality = "Pristina";
            text = "<h4 style='text-align:center; width:100%; height:40px; position:absolute; text-align:left;'>"+ municipality +"</h4>"
            $("#aster-text").empty();
            $("#aster-text").append(text);
            $("#aster-chart").find("#" + slugify(municipality)).d3Click();
            start(muni, s_or_d, aster_div, data, "value");
            drawMap(indicator, s_or_d, all_data[year]);
            $("#aster-chart").find("path#" + slugify("Kosovo")).d3Click();
        }

        $(document).ready(function(){
            var s_or_d = "S";
            var muni = "Kosovo";
            var viti = $('input[name=radio]:checked', '#my-form').val()
            var aster_div = "aster-chart";
            var aster_text_div = "aster-text";
            start(muni, s_or_d, aster_div, all_data[viti][muni], "label");
            bindIndicatorSelectBox(viti, s_or_d);

            bindSelectBoxOnLabelClick(s_or_d);

            $(document).on('click', '#close-popup, .close', function(event) {
                var year = $('input[name=radio]:checked', '#my-form').val();
                var indicator = $("#indicator-select").val();
                var ranking_by = $('input[name=ranking-radio]:checked').val();
                bindIndicatorSelectBox(year, s_or_d);
                if (ranking_by == "municipality") {
                    rankingByMunicipality(year, indicator, muni, aster_div, s_or_d);
                } else {
                    text = "<h4 style='width:100%; height:40px; position:absolute; text-align:left;'>"+ capitalizeFirstLetter(indicator) +"</h4>"
                    $("#aster-text").empty();
                    $("#aster-text").append(text)
                    $("#" + year).attr("checked");
                    bindIndicatorSelectBox(year, s_or_d);
                    // draw map chart on year radio button click.
                    $("#indicator-select").val(indicator);
                    start(muni, s_or_d, aster_div, all_data[year][muni], "label");
                    drawMap(indicator, "S", all_data[year]);
                    $("#aster-chart").find("#" + slugify(indicator)).d3Click();
                    bindSelectBoxOnLabelClick(s_or_d);
                }
            });

            // Variable for switching between satisfied and dissatisfied datasets
            
            $("input[name=ranking-radio]:radio").change(function () {
                var year = $('input[name=radio]:checked', '#my-form').val();
                bindIndicatorSelectBox(year, s_or_d);
                var ranking_by = $('input[name=ranking-radio]:checked').val();
                var indicator = $("#indicator-select").val();
                if (ranking_by == "municipality") {
                    rankingByMunicipality(year, indicator, muni, aster_div, s_or_d);
                } else {
                    start(muni, s_or_d, aster_div, all_data[year]["Kosovo"], "label");
                    bindSelectBoxOnLabelClick(s_or_d);
                    $("#aster-chart").find("path#" + slugify(indicator)).d3Click();
                }
            });

            $("input[name=radio]:radio").change(function () {
                var ranking_by = $('input[name=ranking-radio]:checked').val();
                var year = $('input[name=radio]:checked', '#my-form').val()
                bindIndicatorSelectBox(year, s_or_d);
                var indicator = $("#indicator-select").val();
                if (ranking_by == "municipality") {
                    rankingByMunicipality(year, indicator, muni, aster_div, s_or_d);
                } else {
                    aster_data = all_data[year][muni];
                    text = "<h4 style='width:100%; height:40px; position:absolute; text-align:left;'>"+ indicator +"</h4>"
                    $("#aster-text").empty();
                    $("#aster-text").append(text);
                    indicator_id = indicator.replace("Satisfaction with ", "");
                    $("#" + slugify(indicator_id)).d3Click();
                    // draw map chart on year radio button click.
                    start(muni, s_or_d, aster_div, all_data[year]["Kosovo"], "label");
                    drawMap(indicator, "S", all_data[year]);

                    bindSelectBoxOnLabelClick(s_or_d);
                    $("#aster-chart").find("#" + slugify(indicator)).d3Click();
                }
            });

            $("#indicator-select").change(function(){
                var ranking_by = $('input[name=ranking-radio]:checked').val();
                var indicator = $("#indicator-select").val();
                var year = $('input[name=radio]:checked', '#my-form').val();
                if (ranking_by == "municipality") {
                    rankingByMunicipality(year, indicator, muni, aster_div, s_or_d);
                } else {
                    text = "<h4 style='width:100%; height:40px; position:absolute; text-align:left;'>"+ capitalizeFirstLetter(indicator) +"</h4>"
                    $("#aster-text").empty();
                    $("#aster-text").append(text)
                    drawMap(indicator, s_or_d, all_data[year]);
                    indicator_id = indicator.replace("Satisfaction with ", "");
                    $("#aster-chart").find("path#" + slugify(indicator_id)).d3Click();
                    bindSelectBoxOnLabelClick(s_or_d);
                }
            });

            var ranking_by = $('input[name=ranking-radio]:checked').val();
            var indicator = $("#indicator-select").val();
            if (ranking_by == "municipality") {
                rankingByMunicipality(viti, indicator, muni, aster_div, s_or_d);
                drawMap("family medical centers", "S", all_data[viti]);
            } else {
                $("#aster-chart").find("#" + slugify(indicator)).d3Click();
                // draw map chart in page load.
                drawMap("family medical centers", "S", all_data[viti]);
            }
        })
    </script>
</head>
<body>
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="http://www.undp.org/content/dam/kosovo/docs/Mozaik/Kosovo_Mosaic_2012_Eng_735317.pdf">Kosovo Mosaic Visualizer</a>
            </div>
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="index.html">Visualizer</a></li>
                    <li><a href="shq/indicators.html">Indicators</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li class="active"><a href="index.html">Shqip</a></li>
                    <li><a href="srb/index.html">Srpski</a></li>
                </ul>
            </div> <!-- navbar-collapse -->
        </div> <!-- container-fluid -->
    </nav>
    <div class="container-fluid">
        <div class="row" style="margin-top: 10px;">
            <form id="my-form">
                <div class="col-md-2">
                </div>
                <div class="col-md-3">
                    <select id="indicator-select" class="form-control">
                    </select>
                    <br>
                </div>
                <div class="col-md-5">
                    <div class="form-inline">
                        <div class="form-group">
                            <input type="radio" name="radio" id="2015" value="2015" class="radio" checked/>
                            <label for="2015">2015</label>
                        </div>
                        <div class="form-group">
                            <input type="radio" name="radio" id="2012" value="2012" class="radio"/>
                            <label for="2012">2012</label>
                        </div>
                        <div class="form-group">
                            <input type="radio" name="radio" id="2009" value="2009" class="radio"/>
                            <label for="2009">2009</label>
                        </div>
                        <div class="form-group">
                            <input type="radio" name="radio" id="2006" value="2006" class="radio"/>
                            <label for="2006">2006</label>
                        </div>
                        <div class="form-group">
                            <input type="radio" name="radio" id="2003" value="2003" class="radio"/>
                            <label for="2003">2003</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                </div>
            </form>
        </div>
        <br>
        <div class="row">
            <hr class="style-eight" style="width: 80%" />
            <div class="col-md-7">
                <div id="container" style="height:550px;"></div>
            </div>
            <div class="col-md-5" style="height:500px;">
                <div class="form-inline">
                    <div class="form-group">
                        <label style="border: 0px;">Ranking by: </label>
                    </div>
                    <div class="form-group">
                        <input type="radio" name="ranking-radio" selected="selected" id="kosovo-level" value="kosovo-level" class="radio" />
                        <label for="kosovo-level">Kosovo Level</label>
                    </div>
                    <div class="form-group">
                        <input type="radio" name="ranking-radio" id="municipality" value="municipality" class="radio" />
                        <label for="municipality">Municipality</label>
                    </div>
                </div>
                <div id="aster-text" style="width:100%; height:40px; position:absolute; text-align:left;">
                </div>
                <br><br>
                <div id="aster-chart" style="width:100%;">
                </div>
            </div>
        </div>
    </div>
    <button id="popup-button" type="button" class="btn btn-info btn-lg" data-toggle="modal" style="display:none;" data-target="#myModal">Open Modal</button>
    <!-- Modal -->
    <div class="modal fade" data-backdrop="static" data-keyboard="false" id="myModal" role="dialog">
        <div class="modal-dialog" style="width:95%;">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="navbar-collapse modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title" style="text-align: center"></h4>
                </div>
                <div class="modal-body">
                    <p id="municipality-popup"></p>
                    <div class="row">
                        <div class="col-md-6">
                            <div id="aster-text-popup" style="margin-left: 50px; width: 100%; height:40px; float:left; position:absolute; text-align:left;">
                            </div>
                            <br><br>
                            <div id="aster-chart-popup" style="min-width: 310px; width:330; margin-left: 50px;">
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div id="line-chart" style="min-width: 330px; max-width: 100%; width:500px; height: 400px;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" id="close-popup" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Aster chart script -->
    <script src="static/js/draw.js" ></script>

</body>
</html>